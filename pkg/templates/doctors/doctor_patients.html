{% extends "doctors/dashboard_layout.html" %}
{% block content %}

<main class="container-fluid">
    <div class="row">

        <div class="col-lg-2 d-none d-lg-block"></div>

        <div class="col-lg-10 p-4">

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold mb-1">
                        <i class="fas fa-users me-2 text-primary"></i>My Patients
                    </h3>
                    <small class="text-muted">A complete list of patients you've attended to.</small>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('doctor_appointments') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-calendar-check me-2"></i>Appointments
                    </a>
                </div>
            </div>

            <!-- Toolbar: Search + Stats -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-3 p-md-4">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                                <input id="patientSearch" type="text" class="form-control"
                                    placeholder="Search by name, email, or phone">
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="d-inline-flex align-items-center gap-3">
                                <span class="badge bg-primary-subtle text-primary px-3 py-2">
                                    <i class="fas fa-user-friends me-2"></i>
                                    <strong id="totalCount">{{ patients|length }}</strong> total
                                </span>
                                <span class="badge bg-success-subtle text-success px-3 py-2">
                                    <i class="fas fa-user-check me-2"></i>
                                    <strong id="visibleCount">{{ patients|length }}</strong> visible
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if patients and patients|length > 0 %}
            <!-- Patients Grid -->
            <div id="patientsGrid" class="row g-4">
                {% for p in patients %}
                {% set my_apps = p.appointments | selectattr('doctor_id','equalto', doctor.doctor_id) | list %}
                {% set apps_count = my_apps|length %}
                {% if apps_count > 0 %}
                {% set last_date = (my_apps | map(attribute='appointment_date') | max) %}
                {% else %}
                {% set last_date = None %}
                {% endif %}

                <div class="col-12 col-md-6 col-xl-4 patient-card"
                    data-name="{{ (p.patient_fname ~ ' ' ~ p.patient_lname)|lower }}"
                    data-email="{{ (p.patient_email or '')|lower }}" data-phone="{{ (p.phone_num or '')|lower }}">
                    <div class="card shadow-sm border-0 rounded-4 h-100">
                        <div class="card-body p-3 p-md-4 d-flex flex-column">
                            <div class="d-flex align-items-center mb-3">
                                <img src="/static/uploads/patients/{{ p.patient_profilepic or 'default_patient.png' }}"
                                    class="rounded-circle border border-3 border-primary"
                                    alt="{{ p.patient_fname }} {{ p.patient_lname }}" width="64" height="64"
                                    style="object-fit:cover;">
                                <div class="ms-3">
                                    <h5 class="fw-bold mb-1">{{ p.patient_fname }} {{ p.patient_lname }}</h5>
                                    <div class="text-muted small">
                                        {% if p.patient_gender %}
                                        <span class="me-2"><i class="fas fa-venus-mars me-1"></i>{{
                                            p.patient_gender|capitalize }}</span>
                                        {% endif %}
                                        {% if p.patient_dob %}
                                        <span><i class="fas fa-birthday-cake me-1"></i>{{ p.patient_dob.strftime('%b %d,
                                            %Y') }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row small g-2 mb-3">
                                <div class="col-12">
                                    <i class="fas fa-envelope text-muted me-2"></i>
                                    <span class="text-break">{{ p.patient_email }}</span>
                                </div>
                                {% if p.phone_num %}
                                <div class="col-12">
                                    <i class="fas fa-phone text-muted me-2"></i>
                                    <span>{{ p.phone_num }}</span>
                                </div>
                                {% endif %}
                                {% if p.patient_address %}
                                <div class="col-12">
                                    <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                    <span class="text-truncate d-inline-block" style="max-width: 100%;">{{
                                        p.patient_address }}</span>
                                </div>
                                {% endif %}
                            </div>

                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-calendar-day me-1 text-primary"></i>
                                    Last visit:
                                    {% if last_date %}
                                    <strong class="ms-1">{{ last_date.strftime('%b %d, %Y') }}</strong>
                                    {% else %}
                                    <span class="ms-1">â€”</span>
                                    {% endif %}
                                </span>
                                <span class="badge bg-light text-dark border">
                                    <i class="fas fa-notes-medical me-1 text-success"></i>
                                    Appointments with you: <strong class="ms-1">{{ apps_count }}</strong>
                                </span>
                                {% if my_apps|selectattr('status','equalto','completed')|list|length > 0 %}
                                <span class="badge bg-success-subtle text-success">
                                    <i class="fas fa-check-circle me-1"></i>{{
                                    my_apps|selectattr('status','equalto','completed')|list|length }} completed
                                </span>
                                {% endif %}
                            </div>

                            <div class="mt-auto d-flex gap-2">
                                <a href="{{ url_for('doctor_view_patient', id=p.patient_id) }}"
                                    class="btn btn-primary flex-fill">
                                    <i class="fas fa-user me-2"></i>View Patient
                                </a>
                                <a href="{{ url_for('doctor_appointments') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-list"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body p-5 text-center text-muted">
                    <i class="fas fa-users fa-2x mb-3"></i>
                    <p class="mb-0">No patients yet. Once you consult patients, they will appear here.</p>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</main>

<script>
    // Simple client-side search across name, email, and phone
    (function () {
        const input = document.getElementById('patientSearch');
        const cards = Array.from(document.querySelectorAll('#patientsGrid .patient-card'));
        const visibleCount = document.getElementById('visibleCount');

        if (!input || cards.length === 0) return;

        const matches = (el, q) => {
            q = q.toLowerCase().trim();
            if (!q) return true;
            return (
                el.dataset.name.includes(q) ||
                el.dataset.email.includes(q) ||
                el.dataset.phone.includes(q)
            );
        };

        const run = () => {
            let shown = 0;
            cards.forEach(card => {
                if (matches(card, input.value)) {
                    card.classList.remove('d-none');
                    shown++;
                } else {
                    card.classList.add('d-none');
                }
            });
            if (visibleCount) visibleCount.textContent = shown;
        };

        input.addEventListener('input', run);
    })();
</script>

{% endblock %}