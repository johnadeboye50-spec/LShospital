{% extends "doctors/dashboard_layout.html" %}
{% block content %}

<main class="container-fluid">
    <div class="row">

        <div class="col-lg-2 d-none d-lg-block"></div>

        <div class="col-lg-10 p-4">

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold mb-1">
                        <i class="fas fa-user-injured me-2 text-primary"></i>Patient Profile
                    </h3>
                    <small class="text-muted">Complete medical history and records</small>
                </div>
                <div>
                    <a href="{{ url_for('doctor_patients') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Patients
                    </a>
                </div>
            </div>

            <!-- Patient Information Card -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            <img src="/static/uploads/patients/{{ patient.patient_profilepic or 'default_patient.png' }}"
                                class="rounded-circle border border-4 border-primary shadow"
                                alt="{{ patient.patient_fname }} {{ patient.patient_lname }}" width="150" height="150"
                                style="object-fit:cover;">
                            <h5 class="fw-bold mt-3 mb-0">
                                {{ patient.patient_fname }} {{ patient.patient_lname }}
                            </h5>
                            <small class="text-muted">Patient ID: #{{ patient.patient_id }}</small>
                        </div>

                        <div class="col-md-9">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Email Address</small>
                                        <strong><i class="fas fa-envelope me-2 text-primary"></i>{{
                                            patient.patient_email }}</strong>
                                    </div>
                                </div>
                                {% if patient.phone_num %}
                                <div class="col-md-6">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Phone Number</small>
                                        <strong><i class="fas fa-phone me-2 text-primary"></i>{{ patient.phone_num
                                            }}</strong>
                                    </div>
                                </div>
                                {% endif %}
                                {% if patient.patient_dob %}
                                <div class="col-md-6">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Date of Birth</small>
                                        <strong>
                                            <i class="fas fa-birthday-cake me-2 text-primary"></i>
                                            {{ patient.patient_dob.strftime("%b %d, %Y") }}
                                            <span class="badge bg-light text-dark ms-2">
                                                {% set today = (consultations[0].date if consultations else
                                                appointments[0].appointment_date if appointments else None) %}
                                                {% if today %}
                                                {{ ((today.date() if today.__class__.__name__ == 'datetime' else today)
                                                - patient.patient_dob).days // 365 }} yrs
                                                {% else %}
                                                Age N/A
                                                {% endif %}
                                            </span>
                                        </strong>
                                    </div>
                                </div>
                                {% endif %}
                                {% if patient.patient_gender %}
                                <div class="col-md-6">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Gender</small>
                                        <strong><i class="fas fa-venus-mars me-2 text-primary"></i>{{
                                            patient.patient_gender|capitalize }}</strong>
                                    </div>
                                </div>
                                {% endif %}
                                {% if patient.patient_address %}
                                <div class="col-md-12">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Address</small>
                                        <strong><i class="fas fa-map-marker-alt me-2 text-primary"></i>{{
                                            patient.patient_address }}</strong>
                                    </div>
                                </div>
                                {% endif %}
                                {% if patient.patient_bio %}
                                <div class="col-md-12">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Bio</small>
                                        <p class="mb-0 text-muted">{{ patient.patient_bio }}</p>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="col-md-12">
                                    <div class="border-start border-primary border-4 ps-3">
                                        <small class="text-muted d-block">Registration Date</small>
                                        <strong><i class="fas fa-calendar-check me-2 text-primary"></i>{{
                                            patient.patient_regdate.strftime("%B %d, %Y") }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 rounded-4 h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-calendar-check fa-2x text-primary mb-3"></i>
                            <h3 class="fw-bold mb-1">{{ appointments|length }}</h3>
                            <small class="text-muted">Total Appointments with You</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 rounded-4 h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-file-medical fa-2x text-success mb-3"></i>
                            <h3 class="fw-bold mb-1">{{ consultations|length }}</h3>
                            <small class="text-muted">Completed Consultations</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 rounded-4 h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                            <h3 class="fw-bold mb-1">
                                {% if appointments|length > 0 %}
                                {{ appointments[0].appointment_date.strftime("%b %d, %Y") }}
                                {% else %}
                                —
                                {% endif %}
                            </h3>
                            <small class="text-muted">Last Visit</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs nav-fill mb-3" id="patientTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab"
                        data-bs-target="#appointments" type="button" role="tab">
                        <i class="fas fa-calendar-alt me-2"></i>Appointments ({{ appointments|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="consultations-tab" data-bs-toggle="tab" data-bs-target="#consultations"
                        type="button" role="tab">
                        <i class="fas fa-notes-medical me-2"></i>Consultations ({{ consultations|length }})
                    </button>
                </li>
            </ul>

            <!-- Tabs Content -->
            <div class="tab-content" id="patientTabsContent">

                <!-- Appointments Tab -->
                <div class="tab-pane fade show active" id="appointments" role="tabpanel">
                    {% if appointments and appointments|length > 0 %}
                    <div class="card shadow-sm border-0 rounded-4">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="py-3 px-4">Date & Time</th>
                                            <th class="py-3">Patient Note</th>
                                            <th class="py-3">Doctor Note</th>
                                            <th class="py-3">Status</th>
                                            <th class="py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for app in appointments %}
                                        <tr>
                                            <td class="px-4 py-3">
                                                <div>
                                                    <strong>{{ app.appointment_date.strftime("%b %d, %Y") }}</strong>
                                                </div>
                                                <small class="text-muted">{{ app.appointment_time.strftime("%I:%M %p")
                                                    }}</small>
                                            </td>
                                            <td class="py-3">
                                                {% if app.patient_note %}
                                                <small class="text-muted">{{ app.patient_note[:60] }}{% if
                                                    app.patient_note|length > 60 %}...{% endif %}</small>
                                                {% else %}
                                                <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                            <td class="py-3">
                                                {% if app.doctor_note %}
                                                <small class="text-muted">{{ app.doctor_note[:60] }}{% if
                                                    app.doctor_note|length > 60 %}...{% endif %}</small>
                                                {% else %}
                                                <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                            <td class="py-3">
                                                <span class="badge
                                                    {% if app.status == 'pending' %} bg-warning text-dark
                                                    {% elif app.status == 'accepted' %} bg-success
                                                    {% elif app.status == 'declined' %} bg-danger
                                                    {% elif app.status == 'completed' %} bg-primary
                                                    {% elif app.status == 'cancelled' %} bg-secondary
                                                    {% endif %}">
                                                    {{ app.status|capitalize }}
                                                </span>
                                            </td>
                                            <td class="py-3">
                                                {% if app.status == 'completed' %}
                                                {% set consult = consultations|selectattr('app_id', 'equalto',
                                                app.app_id)|first %}
                                                {% if consult %}
                                                <a href="{{ url_for('doctor_view_consultation', id=app.app_id) }}"
                                                    class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>
                                                {% else %}
                                                <span class="text-muted small">No consultation</span>
                                                {% endif %}
                                                {% else %}
                                                <span class="text-muted small">—</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="card shadow-sm border-0 rounded-4">
                        <div class="card-body p-5 text-center text-muted">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p class="mb-0">No appointments found with this patient.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Consultations Tab -->
                <div class="tab-pane fade" id="consultations" role="tabpanel">
                    {% if consultations and consultations|length > 0 %}
                    <div class="row g-4">
                        {% for consult in consultations %}
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 rounded-4 h-100">
                                <div class="card-header bg-primary text-white rounded-top-4 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-stethoscope me-2"></i>
                                            {{ consult.date.strftime("%B %d, %Y") }}
                                        </h6>
                                        <small>{{ consult.date.strftime("%I:%M %p") }}</small>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-3">
                                        <strong class="text-primary d-block mb-2">
                                            <i class="fas fa-diagnoses me-2"></i>Diagnosis
                                        </strong>
                                        <p class="text-muted mb-0" style="white-space: pre-line;">
                                            {{ consult.diagnose[:150] }}{% if consult.diagnose|length > 150 %}...{%
                                            endif %}
                                        </p>
                                    </div>

                                    {% if consult.treatment %}
                                    <div class="mb-3">
                                        <strong class="text-success d-block mb-2">
                                            <i class="fas fa-medkit me-2"></i>Treatment
                                        </strong>
                                        <p class="text-muted mb-0 small">
                                            {{ consult.treatment[:100] }}{% if consult.treatment|length > 100 %}...{%
                                            endif %}
                                        </p>
                                    </div>
                                    {% endif %}

                                    {% if consult.medications %}
                                    <div class="mb-3">
                                        <strong class="text-warning d-block mb-2">
                                            <i class="fas fa-pills me-2"></i>Medications
                                        </strong>
                                        <p class="text-muted mb-0 small">
                                            {{ consult.medications[:100] }}{% if consult.medications|length > 100
                                            %}...{% endif %}
                                        </p>
                                    </div>
                                    {% endif %}

                                    {% if consult.tests %}
                                    <div class="mb-3">
                                        <strong class="text-info d-block mb-2">
                                            <i class="fas fa-flask me-2"></i>Tests Ordered
                                        </strong>
                                        <p class="text-muted mb-0 small">
                                            {{ consult.tests[:100] }}{% if consult.tests|length > 100 %}...{% endif %}
                                        </p>
                                    </div>
                                    {% endif %}

                                    {% if consult.amt %}
                                    <div class="mb-3">
                                        <strong class="text-dark d-block mb-2">
                                            <i class="fas fa-money-bill-wave me-2"></i>Consultation Fee
                                        </strong>
                                        <h5 class="text-success mb-0">₦{{ '{:,.2f}'.format(consult.amt) }}</h5>
                                    </div>
                                    {% endif %}

                                    <div class="mt-3 pt-3 border-top">
                                        <a href="{{ url_for('doctor_view_consultation', id=consult.app_id) }}"
                                            class="btn btn-primary w-100">
                                            <i class="fas fa-file-medical me-2"></i>View Full Record
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="card shadow-sm border-0 rounded-4">
                        <div class="card-body p-5 text-center text-muted">
                            <i class="fas fa-file-medical-alt fa-3x mb-3"></i>
                            <p class="mb-0">No consultation records available for this patient.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>

        </div>

    </div>
</main>

{% endblock %}